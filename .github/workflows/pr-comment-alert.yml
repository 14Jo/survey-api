# .github/workflows/slack-notify.yml

name: Notify on PR Comment

on:
  issue_comment:
    types: [created]
  pull_request_review:
    types: [submitted]
  pull_request_review_comment:
    types: [created]

jobs:
  notify-slack:
    # ë´‡ì´ ìƒì„±í•œ ì´ë²¤íŠ¸ëŠ” ë¬´ì‹œí•˜ê³ , PRê³¼ ê´€ë ¨ëœ ì´ë²¤íŠ¸ì— ëŒ€í•´ì„œë§Œ ì‹¤í–‰í•©ë‹ˆë‹¤.
    if: github.event.sender.type != 'Bot' && (github.event.issue.pull_request || github.event.pull_request)
    runs-on: ubuntu-latest

    steps:
      - name: Extract Info and Prepare Notification
        id: prepare
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EVENT_CONTEXT: ${{ toJSON(github.event) }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          # ----------------------------------------------------------------
          # 1. ì´ë²¤íŠ¸ ì¢…ë¥˜ì— ë”°ë¼ ê¸°ë³¸ ë³€ìˆ˜ ì„¤ì • ë° ì•Œë¦¼ ì—¬ë¶€ ê²°ì •
          # ----------------------------------------------------------------
          EVENT_TYPE=""
          COMMENT_BODY=""
          COMMENT_AUTHOR=""
          PR_API_URL=""
          COMMENT_HTML_URL=""
          
          if [[ "$EVENT_NAME" == "issue_comment" ]]; then
            # PRì— ë‹¬ë¦° ì¼ë°˜ ëŒ“ê¸€
            COMMENT_BODY=$(echo "$EVENT_CONTEXT" | jq -r '.comment.body')
            # ëŒ“ê¸€ ë‚´ìš©ì´ ì—†ìœ¼ë©´ ì•Œë¦¼ì„ ë³´ë‚´ì§€ ì•Šê³  ì¢…ë£Œí•©ë‹ˆë‹¤.
            if [[ -z "$COMMENT_BODY" || "$COMMENT_BODY" == "null" ]]; then
              echo "Comment body is empty. Exiting."
              exit 0
            fi
          
            EVENT_TYPE="comment"
            COMMENT_AUTHOR=$(echo "$EVENT_CONTEXT" | jq -r '.comment.user.login')
            PR_API_URL=$(echo "$EVENT_CONTEXT" | jq -r '.issue.pull_request.url')
            COMMENT_HTML_URL=$(echo "$EVENT_CONTEXT" | jq -r '.comment.html_url')

          elif [[ "$EVENT_NAME" == "pull_request_review" ]]; then
            # PR ë¦¬ë·° (approved, changes_requested, commented)
            REVIEW_STATE=$(echo "$EVENT_CONTEXT" | jq -r '.review.state')
            COMMENT_BODY=$(echo "$EVENT_CONTEXT" | jq -r '.review.body')

            if [[ "$REVIEW_STATE" == "commented" ]]; then
              # 'commented' ìƒíƒœì¼ ê²½ìš°, ë¦¬ë·°ì— ë‹¬ë¦° ì „ì²´ ì½”ë©˜íŠ¸ ë‚´ìš©ì´ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
              # ë‚´ìš©ì´ ì—†ìœ¼ë©´ (ë³´í†µ ê°œë³„ ë¼ì¸ ì½”ë©˜íŠ¸ë§Œ ìˆëŠ” ê²½ìš°), ì¤‘ë³µ/ë¹ˆ ì•Œë¦¼ì„ ë§‰ê¸° ìœ„í•´ ë¬´ì‹œí•©ë‹ˆë‹¤.
              if [[ -z "$COMMENT_BODY" || "$COMMENT_BODY" == "null" ]]; then
                echo "Review state is 'commented' and review body is empty. Ignoring."
                exit 0
              fi
              # ë‚´ìš©ì´ ìˆìœ¼ë©´ ì¼ë°˜ ì½”ë©˜íŠ¸ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
              EVENT_TYPE="comment"
            else
              # 'approved' ë˜ëŠ” 'changes_requested' ìƒíƒœë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
              # ì´ ê²½ìš°, ì½”ë©˜íŠ¸ ë‚´ìš©ì´ ì—†ì–´ë„ ì•Œë¦¼ì´ ê°‘ë‹ˆë‹¤.
              EVENT_TYPE="$REVIEW_STATE"
            fi
          
            # ê³µí†µ ë³€ìˆ˜ë“¤ì„ ì„¤ì •í•©ë‹ˆë‹¤.
            COMMENT_AUTHOR=$(echo "$EVENT_CONTEXT" | jq -r '.review.user.login')
            PR_API_URL=$(echo "$EVENT_CONTEXT" | jq -r '.pull_request.url')
            COMMENT_HTML_URL=$(echo "$EVENT_CONTEXT" | jq -r '.review.html_url')

          elif [[ "$EVENT_NAME" == "pull_request_review_comment" ]]; then
            # ì½”ë“œ ë¼ì¸ì— ì§ì ‘ ë‹¬ë¦° ëŒ“ê¸€
            COMMENT_BODY=$(echo "$EVENT_CONTEXT" | jq -r '.comment.body')
            # ëŒ“ê¸€ ë‚´ìš©ì´ ì—†ìœ¼ë©´ ì•Œë¦¼ì„ ë³´ë‚´ì§€ ì•Šê³  ì¢…ë£Œí•©ë‹ˆë‹¤.
            if [[ -z "$COMMENT_BODY" || "$COMMENT_BODY" == "null" ]]; then
              echo "Review comment body is empty. Exiting."
              exit 0
            fi
          
            EVENT_TYPE="comment"
            COMMENT_AUTHOR=$(echo "$EVENT_CONTEXT" | jq -r '.comment.user.login')
            PR_API_URL=$(echo "$EVENT_CONTEXT" | jq -r '.pull_request.url')
            COMMENT_HTML_URL=$(echo "$EVENT_CONTEXT" | jq -r '.comment.html_url')
          
            # ë‹µê¸€ì¸ ê²½ìš°ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
            REPLY_TO_ID=$(echo "$EVENT_CONTEXT" | jq -r '.comment.in_reply_to_id')
            if [[ "$REPLY_TO_ID" != "null" ]]; then
              EVENT_TYPE="reply"
              ORIGINAL_COMMENT_URL="https://api.github.com/repos/${{ github.repository }}/pulls/comments/$REPLY_TO_ID"
              ORIGINAL_COMMENT_DATA=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$ORIGINAL_COMMENT_URL")
              ORIGINAL_COMMENT_AUTHOR=$(echo "$ORIGINAL_COMMENT_DATA" | jq -r '.user.login')
              ORIGINAL_COMMENT_BODY=$(echo "$ORIGINAL_COMMENT_DATA" | jq -r '.body')
          
              echo "original_comment_author=$ORIGINAL_COMMENT_AUTHOR" >> $GITHUB_OUTPUT
              echo "original_comment_body<<EOF" >> $GITHUB_OUTPUT
              echo "$ORIGINAL_COMMENT_BODY" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            fi
          fi

          # ----------------------------------------------------------------
          # 2. PR ìƒì„¸ ì •ë³´ ì¡°íšŒ
          # ----------------------------------------------------------------
          if [[ -z "$PR_API_URL" || "$PR_API_URL" == "null" ]]; then
            echo "Could not determine PR API URL. Exiting."
            exit 1
          fi

          PR_DATA=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$PR_API_URL")
          IS_DRAFT=$(echo "$PR_DATA" | jq -r '.draft')

          # Draft PRì¸ ê²½ìš° ì•Œë¦¼ì„ ë³´ë‚´ì§€ ì•ŠìŠµë‹ˆë‹¤.
          if [[ "$IS_DRAFT" == "true" ]]; then
            echo "This is a draft PR. No notification will be sent."
            exit 0
          fi

          PR_AUTHOR=$(echo "$PR_DATA" | jq -r '.user.login')
          PR_TITLE=$(echo "$PR_DATA" | jq -r '.title')
          PR_HTML_URL=$(echo "$PR_DATA" | jq -r '.html_url')

          # ----------------------------------------------------------------
          # 3. ë‹¤ìŒ ìŠ¤í…ìœ¼ë¡œ ì „ë‹¬í•  ê²°ê³¼ê°’(outputs) ì„¤ì •
          # ----------------------------------------------------------------
          echo "event_type=$EVENT_TYPE" >> $GITHUB_OUTPUT
          echo "pr_title<<EOF" >> $GITHUB_OUTPUT; echo "$PR_TITLE" >> $GITHUB_OUTPUT; echo "EOF" >> $GITHUB_OUTPUT
          echo "pr_author=$PR_AUTHOR" >> $GITHUB_OUTPUT
          echo "comment_author=$COMMENT_AUTHOR" >> $GITHUB_OUTPUT
          echo "pr_url=$PR_HTML_URL" >> $GITHUB_OUTPUT
          echo "comment_url=$COMMENT_HTML_URL" >> $GITHUB_OUTPUT
          echo "comment_body<<EOF" >> $GITHUB_OUTPUT; echo "$COMMENT_BODY" >> $GITHUB_OUTPUT; echo "EOF" >> $GITHUB_OUTPUT

      - name: Map GitHub users to Slack IDs
        id: map-users
        # 'prepare' ë‹¨ê³„ì—ì„œ ì•Œë¦¼ì„ ë³´ë‚´ê¸°ë¡œ ê²°ì •í•œ ê²½ìš°ì—ë§Œ ì´ ë‹¨ê³„ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
        if: steps.prepare.outputs.event_type != ''
        run: |
          # GitHub IDì™€ Slack ë©¤ë²„ IDë¥¼ ë§¤í•‘í•©ë‹ˆë‹¤.
          # Slack ë©¤ë²„ IDëŠ” í”„ë¡œí•„ ë³´ê¸° -> ... -> ë©¤ë²„ ID ë³µì‚¬ ë¡œ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          declare -A GH_TO_SLACK_MAP
          GH_TO_SLACK_MAP["Jindnjs"]="${{ secrets.SLACK_USER_JIN }}"
          GH_TO_SLACK_MAP["LJY981008"]="${{ secrets.SLACK_USER_JUN }}"
          GH_TO_SLACK_MAP["taeung515"]="${{ secrets.SLACK_USER_TAE }}"
          GH_TO_SLACK_MAP["easter1201"]="${{ secrets.SLACK_USER_DOY }}"
          GH_TO_SLACK_MAP["kcc5107"]="${{ secrets.SLACK_USER_GU }}"
          GH_TO_SLACK_MAP["DG0702"]="${{ secrets.SLACK_USER_DONG }}"

          PR_AUTHOR="${{ steps.prepare.outputs.pr_author }}"
          COMMENT_AUTHOR="${{ steps.prepare.outputs.comment_author }}"
          ORIGINAL_COMMENT_AUTHOR="${{ steps.prepare.outputs.original_comment_author }}"

          map_user() {
            local github_user=$1
            local slack_id="${GH_TO_SLACK_MAP[$github_user]}"
            if [ -z "$slack_id" ]; then
              echo "$github_user" # ë§¤í•‘ ì •ë³´ê°€ ì—†ìœ¼ë©´ GitHub IDë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©
            else
              echo "<@$slack_id>" # ë§¤í•‘ ì •ë³´ê°€ ìˆìœ¼ë©´ Slack íƒœê·¸
            fi
          }

          echo "pr_author_slack=$(map_user "$PR_AUTHOR")" >> $GITHUB_OUTPUT
          echo "comment_author_slack=$(map_user "$COMMENT_AUTHOR")" >> $GITHUB_OUTPUT
          echo "original_comment_author_slack=$(map_user "$ORIGINAL_COMMENT_AUTHOR")" >> $GITHUB_OUTPUT

      - name: Send Slack Message
        # 'prepare' ë‹¨ê³„ì—ì„œ ì•Œë¦¼ì„ ë³´ë‚´ê¸°ë¡œ ê²°ì •í•œ ê²½ìš°ì—ë§Œ ì´ ë‹¨ê³„ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
        if: steps.prepare.outputs.event_type != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_BOT_TEST }}
          EVENT_TYPE: ${{ steps.prepare.outputs.event_type }}
          PR_TITLE: ${{ steps.prepare.outputs.pr_title }}
          PR_URL: ${{ steps.prepare.outputs.pr_url }}
          COMMENT_URL: ${{ steps.prepare.outputs.comment_url }}
          COMMENT_BODY: ${{ steps.prepare.outputs.comment_body }}
          ORIGINAL_COMMENT_BODY: ${{ steps.prepare.outputs.original_comment_body }}
          PR_AUTHOR_SLACK: ${{ steps.map-users.outputs.pr_author_slack }}
          COMMENT_AUTHOR_SLACK: ${{ steps.map-users.outputs.comment_author_slack }}
          ORIGINAL_COMMENT_AUTHOR_SLACK: ${{ steps.map-users.outputs.original_comment_author_slack }}
        run: |
          # Slack ë©”ì‹œì§€ì—ì„œ ì¤„ë°”ê¿ˆ ë“±ì„ ì˜¬ë°”ë¥´ê²Œ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ ë³€ìˆ˜ë¥¼ JSON ë¬¸ìì—´ë¡œ ì´ìŠ¤ì¼€ì´í”„í•©ë‹ˆë‹¤.
          escape_json() {
            echo -n "$1" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | sed 's/\n/\\n/g'
          }

          PR_TITLE_ESCAPED=$(escape_json "$PR_TITLE")
          COMMENT_BODY_ESCAPED=$(escape_json "$COMMENT_BODY")
          ORIGINAL_COMMENT_BODY_ESCAPED=$(escape_json "$ORIGINAL_COMMENT_BODY")

          # ì´ë²¤íŠ¸ íƒ€ì…ì— ë”°ë¼ ë‹¤ë¥¸ ë©”ì‹œì§€ë¥¼ êµ¬ì„±í•©ë‹ˆë‹¤.
          if [[ "$EVENT_TYPE" == "approved" ]]; then
            TEXT="âœ… *PR ìŠ¹ì¸* âœ…\n\n*PR:* <$PR_URL|$PR_TITLE_ESCAPED>\n*ì‘ì„±ì:* $PR_AUTHOR_SLACK\n*ìŠ¹ì¸ì:* $COMMENT_AUTHOR_SLACK"
            if [[ -n "$COMMENT_BODY" ]]; then
              TEXT="$TEXT\n*ì½”ë©˜íŠ¸:*\n> $COMMENT_BODY_ESCAPED"
            fi
          elif [[ "$EVENT_TYPE" == "changes_requested" ]]; then
            TEXT="âš ï¸ *PR ë³€ê²½ ìš”ì²­* âš ï¸\n\n*PR:* <$PR_URL|$PR_TITLE_ESCAPED>\n*ì‘ì„±ì:* $PR_AUTHOR_SLACK\n*ìš”ì²­ì:* $COMMENT_AUTHOR_SLACK"
            if [[ -n "$COMMENT_BODY" ]]; then
              TEXT="$TEXT\n*ì½”ë©˜íŠ¸:*\n> $COMMENT_BODY_ESCAPED"
            fi
          elif [[ "$EVENT_TYPE" == "reply" ]]; then
            TEXT="ğŸ’¬ *ëŒ“ê¸€ì— ë‹µê¸€ì´ ë‹¬ë ¸ìŠµë‹ˆë‹¤*\n\n*PR:* <$PR_URL|$PR_TITLE_ESCAPED>\n\n*ì› ëŒ“ê¸€:* ($ORIGINAL_COMMENT_AUTHOR_SLACK)\n> $ORIGINAL_COMMENT_BODY_ESCAPED\n\n*ë‹µê¸€:* ($COMMENT_AUTHOR_SLACK)\n> <$COMMENT_URL|ë‹µê¸€ ë³´ê¸°>\n> $COMMENT_BODY_ESCAPED"
          else # "comment"
            TEXT="ğŸ’¬ *ìƒˆë¡œìš´ ë¦¬ë·° ìš”ì²­ì´ ìˆìŠµë‹ˆë‹¤*\n\n*PR:* <$PR_URL|$PR_TITLE_ESCAPED>\n*ì‘ì„±ì:* $PR_AUTHOR_SLACK\n*ë¦¬ë·°ì–´:* $COMMENT_AUTHOR_SLACK\n*ì½”ë©˜íŠ¸:*\n> <$COMMENT_URL|ëŒ“ê¸€ ë³´ê¸°>\n> $COMMENT_BODY_ESCAPED"
          fi

          # ìµœì¢… ë©”ì‹œì§€ë¥¼ JSON í˜ì´ë¡œë“œë¡œ ë§Œë“­ë‹ˆë‹¤.
          JSON_PAYLOAD="{\"text\": \"$TEXT\"}"

          # Slackìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•©ë‹ˆë‹¤.
          curl -X POST -H 'Content-type: application/json' --data "$JSON_PAYLOAD" $SLACK_WEBHOOK_URL
